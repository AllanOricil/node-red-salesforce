<script type="text/html" data-template-name="salesforce-connection">
  <div class="form-row">
    <label for="node-config-input-name">
      <i class="fa fa-id-card-o"></i>
      <span data-i18n="salesforce.label.connection_name">Name</span>
    </label>
    <input type="text" id="node-config-input-name" />
  </div>

  <div class="form-row">
    <label for="node-config-input-instance_url">
      <i class="fa fa-laptop"></i>
      <span data-i18n="salesforce.label.instance_url">Instance URL</span>
    </label>
    <input type="text" id="node-config-input-instance_url" />
  </div>

  <div class="form-row">
    <label for="node-config-input-username">
      <i class="fa fa-user"></i>
      <span data-i18n="salesforce.label.username">Username</span>
    </label>
    <input type="text" id="node-config-input-username" />
  </div>

  <div class="form-row">
    <label for="node-config-input-password">
      <i class="fa fa-key"></i>
      <span data-i18n="salesforce.label.password">Password</span>
    </label>
    <input type="password" id="node-config-input-password" />
  </div>

  <div class="form-row">
    <label for="node-config-input-connected_app_client_id">
      <i class="fa fa-sitemap"></i>
      <span data-i18n="salesforce.label.connected_app_client_id">
        Client ID
      </span>
    </label>
    <input type="password" id="node-config-input-connected_app_client_id" />
  </div>

  <div class="form-row">
    <label for="node-config-input-connected_app_client_secret">
      <i class="fa fa-sitemap"></i>
      <span data-i18n="salesforce.label.connected_app_client_secret">
        Client Secret
      </span>
    </label>
    <input type="password" id="node-config-input-connected_app_client_secret" />
  </div>

  <div class="form-row">
    <label for="node-config-input-api_version">
      <i class="fa fa-gear"></i>
      <span data-i18n="salesforce.label.api_version">API Version</span>
    </label>
    <select type="text" id="node-config-input-api_version">
      <option value="60.0">v60.0</option>
      <option value="59.0">v59.0</option>
      <option value="58.0">v58.0</option>
      <option value="57.0">v57.0</option>
      <option value="56.0">v56.0</option>
      <option value="55.0">v55.0</option>
      <option value="54.0">v54.0</option>
      <option value="53.0">v53.0</option>
      <option value="52.0">v52.0</option>
      <option value="51.0">v51.0</option>
      <option value="50.0">v50.0</option>
      <option value="49.0">v49.0</option>
      <option value="48.0">v48.0</option>
      <option value="47.0">v47.0</option>
      <option value="46.0">v46.0</option>
      <option value="44.0">v44.0</option>
      <option value="43.0">v43.0</option>
      <option value="42.0">v42.0</option>
      <option value="41.0">v41.0</option>
      <option value="40.0">v40.0</option>
      <option value="39.0">v39.0</option>
      <option value="38.0">v38.0</option>
      <option value="37.0">v37.0</option>
      <option value="36.0">v36.0</option>
      <option value="35.0">v35.0</option>
      <option value="34.0">v34.0</option>
    </select>
  </div>

  <button
    type="button"
    id="button"
    onclick="testConnection()"
    class="red-ui-button red-ui-button-small"
  >
    Test Connection
  </button>
  <span id="testresult"></span>
</script>

<script type="text/javascript">
  RED.nodes.registerType('salesforce-connection', {
    category: 'config',
    defaults: {
      name: { value: '', required: false },
      instance_url: { value: 'https://login.salesforce.com', required: true },
      api_version: { value: '60.0', required: true },
    },
    credentials: {
      username: { type: 'text', required: true },
      password: { type: 'password', required: true },
      connected_app_client_id: { type: 'password', required: true },
      connected_app_client_secret: { type: 'password', required: true },
    },
    exportable: false,
    label: function () {
      return this.name || this.instance_url;
    },
    oneditprepare: function () {
      // Store the node ID in a variable for use in the testConnection function
      var nodeId = this.id;

      window.testConnection = function () {
        console.log(
          `Button clicked - Test Salesforce connection for node Id: ${nodeId}`,
        );
        var params = {
          id: nodeId,
          username: document.getElementById('node-config-input-username').value,
          password: document.getElementById('node-config-input-password').value,
          instance_url: document.getElementById(
            'node-config-input-instance_url',
          ).value,
          connected_app_client_id: document.getElementById(
            'node-config-input-connected_app_client_id',
          ).value,
          connected_app_client_secret: document.getElementById(
            'node-config-input-connected_app_client_secret',
          ).value,
        };
        console.log(params);
        $.ajax({
          url: 'test-salesforce-connection',
          type: 'POST',
          contentType: 'application/json',
          data: JSON.stringify(params),
          success: function (res) {
            console.log('Response:', res);
            testresult.textContent = 'CONNECTION OK';
            testresult.style.color = 'green';
          },
          error: function (xhr, status, error) {
            console.log(error);
            console.error('Error:', status, error);
            testresult.textContent = `CONNECTION FAILED: ${error}`;
            testresult.style.color = 'red';
          },
        });
      };
    },
  });
</script>
