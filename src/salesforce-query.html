<script type="text/html" data-template-name="salesforce-query">
  <!-- Connection selection -->
  <div class="form-row">
    <label for="node-input-connection">
      <i class="fa fa-sitemap"></i>
      <span data-i18n="salesforce.label.salesforce_connection"></span>
    </label>
    <input type="text" id="node-input-connection" />
  </div>
  
  <!-- SOQL editor -->
  <div class="form-row node-text-editor-row">
    <label for="node-input-soql">
      <i class="fa fa-database"></i>
      <span id="node-input-soql-label" data-i18n="salesforce.label.soql">SOQL Query</span>
    </label>
  <div style="height: 250px; min-height:150px;" class="node-text-editor" id="node-input-query_editor"></div>
  </div>

  <!-- Output style -->
  <div class="form-row">
    <label for="node-input-outputStyle">
        <i class="fa fa-random"></i>
        <span>Output Style</span>
    </label>
    <select id="node-input-outputStyle">
        <option value="messageAllRecords" selected>1 Message all records (default)</option>
        <option value="messagePerRecord">Message for each record</option>
    </select>
  </div>
    <!-- Output style -->
    <div id="endMessageComponent">
    <div class="form-row" >
      <label for="node-input-endMessage">
          <i class="fa fa-flag-checkered"></i>
          <span>End Message</span>
      </label>
      <select id="node-input-endMessage">
          <option value="none" selected>None (default)</option>
          <option value="inStream">End message in stream</option>
          <option value="inNodeOutput">End message in seperate node output</option>
      </select>
      <input type="hidden" id="node-input-outputs"/>
    </div>
    <!-- Max fetch  maximum numbers to fetch-->
    <div class="form-row">
      <label for="node-input-maxFetch">
          <i class="fa fa-download"></i>
          <span>Max records</span>
      </label>
      <input type="number" id="node-input-maxFetch" style="width: 30%;" min="1"  value="10000">
    </div>
    <div class="form-row">
      <label for="node-input-delay">
          <i class="fa fa-download"></i>
          <span>Delay in ms</span>
      </label>
      <input type="number" id="node-input-delay" style="width: 30%;" min="1"  value="10">
    </div>
    </div>
</script>

<script type="text/javascript">
  RED.nodes.registerType('salesforce-query', {
    category: 'sf',
    color: '#FFFFFF',
    defaults: {
      connection: {value: '',  type: 'salesforce-connection'},
      query: {value: 'Select Id From Account LIMIT 1'},
      outputStyle: {value:"messageAllRecords", required:true}, // Default to 'allRecords'
      endMessage: {value:"none", required:true}, // Default to "none"
      outputs: {value: 1}, // Default output count 1, when message per record and "inNodeOutput" create additional output
      maxFetch: {value: 10000 }, // max records to fetch
      delay: {value: 10 } // delay in milliseconds between releasing records
    },
    inputs: 1, // gets updated dynamically when 'endMessage inNodeOutput'
    outputs: 1,
    outputLabels: ["Record Output", "End Message Output"],

    icon: 'salesforce.png',
    label: 'Query',
    oneditprepare: function () {
      // Editor 
      this.editor = RED.editor.createEditor({
        id: 'node-input-query_editor',
        mode: 'ace/mode/sql',
        value: this.query
     });
      // Set maxFetch from the node's current configuration
      $('#node-input-maxFetch').val(this.maxFetch || 10000);
      $('#node-input-delay').val(this.delay || 10);
      // Function to toggle the visibility of the end message select based on the output style
      function toggleEndMessageVisibilityAndOutput() {
        var outputStyle = $('#node-input-outputStyle').val();
        var endMessage = $('#node-input-endMessage').val();
        // toggle endmessage field when messagePerRecord
        $('#endMessageComponent').toggle(outputStyle === 'messagePerRecord');
        // update Node output value
        $("#node-input-outputs").val(outputStyle === 'messagePerRecord' && endMessage === 'inNodeOutput' ? 2 : 1);
    }
    // Set initial visibility state of the end message options
    toggleEndMessageVisibilityAndOutput();

    // Attach change event to the outputStyle and Endmessage  dropdown to control the visibility and output dynamically
    $('#node-input-outputStyle, #node-input-endMessage').on('change', function() {
      console.log('running')
      toggleEndMessageVisibilityAndOutput();
    });

    },
    oneditsave: function() {
      this.query = this.editor.getValue();
      this.maxFetch = $('#node-input-maxFetch').val();
      this.delay = $('#node-input-delay').val();
      this.editor.destroy();
      delete this.editor;
  },
  oneditcancel: function() {
      this.editor.destroy();
      delete this.editor;
  },
  
  });
</script>
